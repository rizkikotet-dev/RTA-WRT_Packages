name: ๐ KWRT Packages Sync Pipeline

on:
  # โฐ Daily sync at 02:00 UTC
  schedule:
    - cron: '0 2 * * *'
  
  # ๐ฏ Manual trigger with advanced options
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'โก Force sync regardless of changes'
        required: false
        default: false
        type: boolean
      
      sync_mode:
        description: '๐ Sync mode'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - deep-clean
          - quick-check
      
      notification_level:
        description: '๐ข Notification level'
        required: false
        default: 'normal'
        type: choice
        options:
          - minimal
          - normal
          - verbose

env:
  # ๐ Configuration
  KWRT_REPO_URL: https://github.com/kiddin9/kwrt-packages
  PACKAGES_DIR: packages
  WORKFLOW_VERSION: "2.0.0"
  
  # ๐จ Styling
  EMOJI_SUCCESS: "โจ"
  EMOJI_ERROR: "๐ฅ"
  EMOJI_INFO: "๐ก"
  EMOJI_SYNC: "โก"

jobs:
  # ๐ Pre-flight checks
  preflight:
    name: ๐ก๏ธ Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.validation.outputs.proceed }}
      source_available: ${{ steps.validation.outputs.source_ok }}
    
    steps:
    - name: ๐ Validate Source Repository
      id: validation
      run: |
        echo "๐ Validating source repository accessibility..."
        
        # Check if source repo is accessible
        if curl -s --head "${{ env.KWRT_REPO_URL }}" | head -n 1 | grep -q "200 OK"; then
          echo "โ Source repository is accessible"
          echo "source_ok=true" >> $GITHUB_OUTPUT
          echo "proceed=true" >> $GITHUB_OUTPUT
        else
          echo "โ Source repository is not accessible"
          echo "source_ok=false" >> $GITHUB_OUTPUT
          echo "proceed=false" >> $GITHUB_OUTPUT
        fi

  # ๐ Main sync job
  sync-packages:
    name: ๐ Package Synchronization
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_proceed == 'true'
    
    steps:
    - name: ๐ฏ Initialize Workspace
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ๐ง Configure Environment
      run: |
        echo "๐ง Setting up advanced sync environment..."
        
        # Environment variables
        echo "SOURCE_URL=${{ env.KWRT_REPO_URL }}" >> $GITHUB_ENV
        echo "SYNC_TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "SYNC_ID=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
        echo "WORKFLOW_VERSION=${{ env.WORKFLOW_VERSION }}" >> $GITHUB_ENV
        
        # Sync mode configuration
        case "${{ github.event.inputs.sync_mode || 'standard' }}" in
          "deep-clean")
            echo "SYNC_MODE=๐งน Deep Clean" >> $GITHUB_ENV
            echo "CLEAN_STRATEGY=aggressive" >> $GITHUB_ENV
            ;;
          "quick-check")
            echo "SYNC_MODE=โก Quick Check" >> $GITHUB_ENV
            echo "CLEAN_STRATEGY=minimal" >> $GITHUB_ENV
            ;;
          *)
            echo "SYNC_MODE=๐ Standard" >> $GITHUB_ENV
            echo "CLEAN_STRATEGY=standard" >> $GITHUB_ENV
            ;;
        esac
        
        # Create sync metadata
        echo "๐ Sync Configuration:"
        echo "  ๐ Sync ID: $SYNC_ID"
        echo "  ๐ Timestamp: $(date +'%Y-%m-%d %H:%M:%S UTC')"
        echo "  ๐ Mode: $SYNC_MODE"
        echo "  ๐ฆ Version: ${{ env.WORKFLOW_VERSION }}"

    - name: ๐๏ธ Prepare Workspace
      run: |
        echo "๐๏ธ Preparing synchronized workspace..."
        
        # Create directory structure
        mkdir -p ${{ env.PACKAGES_DIR }}
        mkdir -p .sync-metadata
        
        # Preserve important files
        if [ -f ${{ env.PACKAGES_DIR }}/.gitkeep ]; then
          echo "๐พ Preserving .gitkeep file..."
          cp ${{ env.PACKAGES_DIR }}/.gitkeep .sync-metadata/.gitkeep.backup
        fi
        
        # Create sync manifest
        cat > .sync-metadata/sync-manifest.json << EOF
        {
          "sync_id": "${{ env.SYNC_ID }}",
          "timestamp": "${{ env.SYNC_TIMESTAMP }}",
          "source_url": "${{ env.KWRT_REPO_URL }}",
          "workflow_version": "${{ env.WORKFLOW_VERSION }}",
          "sync_mode": "${{ env.SYNC_MODE }}",
          "triggered_by": "${{ github.event_name }}",
          "actor": "${{ github.actor }}"
        }
        EOF
        
        echo "โ Workspace prepared successfully!"

    - name: ๐ก Fetch Source Repository
      run: |
        echo "๐ก Fetching latest packages from source..."
        echo "๐ฏ Source: ${{ env.KWRT_REPO_URL }}"
        
        # Download with progress and retry logic
        for attempt in 1 2 3; do
          echo "๐ Attempt $attempt/3..."
          
          if wget -q --show-progress --progress=bar:force \
            --timeout=30 --tries=3 \
            -O kwrt-packages.zip \
            "${{ env.KWRT_REPO_URL }}/archive/refs/heads/main.zip"; then
            
            echo "โ Download successful on attempt $attempt!"
            break
          else
            echo "โ๏ธ Attempt $attempt failed, retrying..."
            [ $attempt -eq 3 ] && exit 1
            sleep 5
          fi
        done
        
        # Verify download
        if [ ! -f kwrt-packages.zip ] || [ ! -s kwrt-packages.zip ]; then
          echo "โ Download verification failed!"
          exit 1
        fi
        
        echo "๐ Download statistics:"
        ls -lah kwrt-packages.zip
        echo "๐ File integrity: $(sha256sum kwrt-packages.zip | cut -d' ' -f1)"

    - name: ๐ Extract and Process
      run: |
        echo "๐ Processing downloaded archive..."
        
        # Extract with verification
        if ! unzip -q kwrt-packages.zip; then
          echo "โ Archive extraction failed!"
          exit 1
        fi
        
        echo "๐งน Applying ${{ env.CLEAN_STRATEGY }} cleaning strategy..."
        
        # Advanced cleaning based on strategy
        case "${{ env.CLEAN_STRATEGY }}" in
          "aggressive")
            echo "๐งน Performing deep clean..."
            rm -rf ${{ env.PACKAGES_DIR }}/*
            rm -rf ${{ env.PACKAGES_DIR }}/.[!.]*
            ;;
          "minimal")
            echo "๐งน Performing minimal clean..."
            find ${{ env.PACKAGES_DIR }} -type f -name "*.tmp" -delete 2>/dev/null || true
            ;;
          *)
            echo "๐งน Performing standard clean..."
            rm -rf ${{ env.PACKAGES_DIR }}/*
            ;;
        esac
        
        # Restore preserved files
        if [ -f .sync-metadata/.gitkeep.backup ]; then
          echo "๐พ Restoring preserved files..."
          mv .sync-metadata/.gitkeep.backup ${{ env.PACKAGES_DIR }}/.gitkeep
        fi
        
        # Process files with enhanced filtering
        echo "๐ฆ Processing package files..."
        cd kwrt-packages-main
        
        # Count and categorize files
        TOTAL_FILES=$(find . -maxdepth 1 -type f -not -name 'README*' -not -name '.*' | wc -l)
        TOTAL_DIRS=$(find . -maxdepth 1 -type d -not -name '.' -not -name '.github' -not -name '.git' | wc -l)
        
        echo "๐ Processing statistics:"
        echo "  ๐ Files: $TOTAL_FILES"
        echo "  ๐ Directories: $TOTAL_DIRS"
        
        # Smart file moving with exclusions
        find . -maxdepth 1 -type f \
          -not -name 'README*' \
          -not -name 'LICENSE*' \
          -not -name '.*' \
          -not -name '*.md' \
          -exec mv {} ../${{ env.PACKAGES_DIR }}/ \; 2>/dev/null || true
        
        find . -maxdepth 1 -type d \
          -not -name '.' \
          -not -name '.github' \
          -not -name '.git' \
          -exec mv {} ../${{ env.PACKAGES_DIR }}/ \; 2>/dev/null || true
        
        cd ..
        
        # Cleanup
        echo "๐งน Cleaning temporary files..."
        rm -rf kwrt-packages.zip kwrt-packages-main .sync-metadata
        
        echo "โ Processing completed successfully!"

    - name: ๐ฌ Advanced Change Analysis
      id: analyze
      run: |
        echo "๐ฌ Performing advanced change analysis..."
        
        # Detailed git analysis
        if [[ -n $(git status --porcelain) ]]; then
          echo "๐ฏ Changes detected!"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Comprehensive change analysis
          ADDED=$(git status --porcelain | grep -c "^A" || echo "0")
          MODIFIED=$(git status --porcelain | grep -c "^M" || echo "0")
          DELETED=$(git status --porcelain | grep -c "^D" || echo "0")
          RENAMED=$(git status --porcelain | grep -c "^R" || echo "0")
          UNTRACKED=$(git status --porcelain | grep -c "^??" || echo "0")
          
          # Calculate change metrics
          TOTAL_CHANGES=$((ADDED + MODIFIED + DELETED + RENAMED + UNTRACKED))
          
          # Set outputs
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "renamed=$RENAMED" >> $GITHUB_OUTPUT
          echo "untracked=$UNTRACKED" >> $GITHUB_OUTPUT
          echo "total_changes=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          
          # Determine change magnitude
          if [ $TOTAL_CHANGES -gt 100 ]; then
            echo "change_magnitude=major" >> $GITHUB_OUTPUT
            echo "๐ฅ Major changes detected ($TOTAL_CHANGES files)"
          elif [ $TOTAL_CHANGES -gt 20 ]; then
            echo "change_magnitude=moderate" >> $GITHUB_OUTPUT
            echo "โก Moderate changes detected ($TOTAL_CHANGES files)"
          else
            echo "change_magnitude=minor" >> $GITHUB_OUTPUT
            echo "โจ Minor changes detected ($TOTAL_CHANGES files)"
          fi
          
          # Enhanced change summary
          echo "๐ Detailed Change Analysis:"
          echo "  โ Added: $ADDED"
          echo "  โ๏ธ Modified: $MODIFIED"
          echo "  โ Deleted: $DELETED"
          echo "  ๐ Renamed: $RENAMED"
          echo "  ๐ Untracked: $UNTRACKED"
          echo "  ๐ Total: $TOTAL_CHANGES"
          
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "total_changes=0" >> $GITHUB_OUTPUT
          echo "change_magnitude=none" >> $GITHUB_OUTPUT
          echo "โน๏ธ No changes detected - repository is up to date"
        fi

    - name: ๐ Smart Commit & Deploy
      if: steps.analyze.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        echo "๐ Deploying changes with smart commit..."
        
        # Configure git with enhanced identity
        git config --global user.email "noreply@github.com"
        git config --global user.name "๐ค KWRT Sync Bot v${{ env.WORKFLOW_VERSION }}"
        
        # Generate smart commit message
        MAGNITUDE="${{ steps.analyze.outputs.change_magnitude || 'forced' }}"
        TOTAL_CHANGES="${{ steps.analyze.outputs.total_changes || '0' }}"
        
        case "$MAGNITUDE" in
          "major")
            COMMIT_ICON="๐ฅ"
            COMMIT_TYPE="feat"
            ;;
          "moderate")
            COMMIT_ICON="โก"
            COMMIT_TYPE="update"
            ;;
          "minor")
            COMMIT_ICON="โจ"
            COMMIT_TYPE="sync"
            ;;
          "forced")
            COMMIT_ICON="๐"
            COMMIT_TYPE="force"
            ;;
          *)
            COMMIT_ICON="๐"
            COMMIT_TYPE="sync"
            ;;
        esac
        
        # Create semantic commit message
        COMMIT_MSG="$COMMIT_ICON $COMMIT_TYPE: KWRT packages sync ($TOTAL_CHANGES changes)

        ๐ฏ Sync Details:
        โโ ๐ Date: ${{ env.SYNC_TIMESTAMP }}
        โโ ๐ ID: ${{ env.SYNC_ID }}
        โโ ๐ Mode: ${{ env.SYNC_MODE }}
        โโ ๐ฆ Version: ${{ env.WORKFLOW_VERSION }}
        โโ ๐ก Source: ${{ env.KWRT_REPO_URL }}
        
        ๐ Change Summary:
        โโ โ Added: ${{ steps.analyze.outputs.added || 0 }}
        โโ โ๏ธ Modified: ${{ steps.analyze.outputs.modified || 0 }}
        โโ โ Deleted: ${{ steps.analyze.outputs.deleted || 0 }}
        โโ ๐ Renamed: ${{ steps.analyze.outputs.renamed || 0 }}
        โโ ๐ New: ${{ steps.analyze.outputs.untracked || 0 }}
        
        ๐ค Automated by GitHub Actions
        ๐ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # Commit and push
        git add ${{ env.PACKAGES_DIR }}/
        git commit -m "$COMMIT_MSG"
        git push
        
        echo "โ Changes deployed successfully!"

    - name: ๐ Generate Advanced Report
      run: |
        echo "๐ Generating comprehensive sync report..."
        
        # Determine status
        if [[ "${{ steps.analyze.outputs.has_changes }}" == "true" ]]; then
          STATUS_ICON="โ"
          STATUS_TEXT="SUCCESS"
          STATUS_COLOR="green"
        elif [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
          STATUS_ICON="๐"
          STATUS_TEXT="FORCED"
          STATUS_COLOR="blue"
        else
          STATUS_ICON="โน๏ธ"
          STATUS_TEXT="NO CHANGES"
          STATUS_COLOR="gray"
        fi
        
        # Generate advanced report
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ๐ KWRT Packages Sync Report v${{ env.WORKFLOW_VERSION }}
        
        ## $STATUS_ICON Status: **$STATUS_TEXT**
        
        ### ๐ Sync Information
        
        | ๐ท๏ธ Property | ๐ Value |
        |-------------|----------|
        | **๐ Sync ID** | \`${{ env.SYNC_ID }}\` |
        | **๐ Timestamp** | \`${{ env.SYNC_TIMESTAMP }}\` |
        | **๐ Mode** | ${{ env.SYNC_MODE }} |
        | **๐ฆ Version** | \`${{ env.WORKFLOW_VERSION }}\` |
        | **๐ค Triggered By** | \`${{ github.actor }}\` |
        | **๐ฏ Event** | \`${{ github.event_name }}\` |
        | **๐ก Source** | [${{ env.KWRT_REPO_URL }}](${{ env.KWRT_REPO_URL }}) |
        | **๐ Workflow** | [Run #${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
        
        EOF
        
        # Add change details if applicable
        if [[ "${{ steps.analyze.outputs.has_changes }}" == "true" ]]; then
          MAGNITUDE="${{ steps.analyze.outputs.change_magnitude }}"
          
          case "$MAGNITUDE" in
            "major") MAGNITUDE_ICON="๐ฅ"; MAGNITUDE_DESC="Major Update" ;;
            "moderate") MAGNITUDE_ICON="โก"; MAGNITUDE_DESC="Moderate Update" ;;
            "minor") MAGNITUDE_ICON="โจ"; MAGNITUDE_DESC="Minor Update" ;;
            *) MAGNITUDE_ICON="๐"; MAGNITUDE_DESC="Standard Update" ;;
          esac
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ### $MAGNITUDE_ICON Change Analysis: **$MAGNITUDE_DESC**
        
        | ๐ Change Type | ๐ข Count | ๐ Impact |
        |----------------|----------|-----------|
        | โ **Added** | \`${{ steps.analyze.outputs.added || 0 }}\` | New packages/files |
        | โ๏ธ **Modified** | \`${{ steps.analyze.outputs.modified || 0 }}\` | Updated content |
        | โ **Deleted** | \`${{ steps.analyze.outputs.deleted || 0 }}\` | Removed items |
        | ๐ **Renamed** | \`${{ steps.analyze.outputs.renamed || 0 }}\` | Restructured files |
        | ๐ **New Files** | \`${{ steps.analyze.outputs.untracked || 0 }}\` | Fresh additions |
        | **๐ฏ Total Changes** | **\`${{ steps.analyze.outputs.total_changes || 0 }}\`** | **Overall impact** |
        
        EOF
        fi
        
        # Add footer
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ---
        
        ### ๐ฏ Quick Actions
        
        - ๐ [View Source Repository](${{ env.KWRT_REPO_URL }})
        - ๐ฆ [Browse Packages](${{ github.server_url }}/${{ github.repository }}/tree/main/${{ env.PACKAGES_DIR }})
        - ๐ [Workflow History](${{ github.server_url }}/${{ github.repository }}/actions/workflows/sync-kwrt.yml)
        - ๐ [Manual Sync](${{ github.server_url }}/${{ github.repository }}/actions/workflows/sync-kwrt.yml)
        
        ---
        
        <div align="center">
        
        **๐ค Powered by GitHub Actions** โข **โก KWRT Sync Bot v${{ env.WORKFLOW_VERSION }}**
        
        *Automated package synchronization for the modern era*
        
        </div>
        EOF

    - name: ๐ Sync Complete
      run: |
        echo "๐ KWRT Packages sync pipeline completed successfully!"
        echo ""
        echo "๐ Final Summary:"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โ                    ๐ SYNC COMPLETED                        โ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
        echo "โ ๐ Sync ID: ${{ env.SYNC_ID }}                   โ"
        echo "โ ๐ Date: ${{ env.SYNC_TIMESTAMP }}                    โ"
        echo "โ ๐ Mode: ${{ env.SYNC_MODE }}                           โ"
        echo "โ ๐ฆ Version: ${{ env.WORKFLOW_VERSION }}                            โ"
        echo "โ ๐ฏ Status: $([ "${{ steps.analyze.outputs.has_changes }}" == "true" ] && echo "โ Updated" || echo "โน๏ธ No changes")                                 โ"
        echo "โ ๐ Changes: ${{ steps.analyze.outputs.total_changes || 0 }} files affected                          โ"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        echo "๐ Next sync scheduled for tomorrow at 02:00 UTC"
        echo "โก Manual sync available via workflow dispatch"