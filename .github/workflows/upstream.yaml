name: ğŸ”„ Sync KWRT Packages

on:
  # ğŸ• Jalankan setiap hari pada jam 02:00 UTC
  schedule:
    - cron: '0 2 * * *'
  
  # ğŸš€ Manual trigger
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'ğŸ”§ Force sync even if no changes'
        required: false
        default: false
        type: boolean

env:
  KWRT_REPO_URL: https://github.com/kiddin9/kwrt-packages
  PACKAGES_DIR: packages

jobs:
  sync-packages:
    name: ğŸ“¦ Sync KWRT Packages
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ—ï¸ Setup Environment
      run: |
        echo "ğŸ”§ Setting up sync environment..."
        echo "SOURCE_URL=${{ env.KWRT_REPO_URL }}" >> $GITHUB_ENV
        echo "SYNC_DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "COMMIT_HASH=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
    
    - name: ğŸ“ Prepare Packages Directory
      run: |
        echo "ğŸ“ Creating packages directory structure..."
        mkdir -p ${{ env.PACKAGES_DIR }}
        
        # ğŸ’¾ Backup .gitkeep if exists
        if [ -f ${{ env.PACKAGES_DIR }}/.gitkeep ]; then
          echo "ğŸ’¾ Backing up .gitkeep file..."
          cp ${{ env.PACKAGES_DIR }}/.gitkeep /tmp/.gitkeep.backup
        fi
    
    - name: â¬‡ï¸ Download KWRT Packages
      run: |
        echo "â¬‡ï¸ Downloading latest KWRT packages..."
        echo "ğŸ“¡ Source: ${{ env.KWRT_REPO_URL }}"
        
        wget -q --show-progress --progress=bar:force \
          -O kwrt-packages.zip \
          ${{ env.KWRT_REPO_URL }}/archive/refs/heads/main.zip
        
        echo "âœ… Download completed successfully!"
        ls -lah kwrt-packages.zip
    
    - name: ğŸ“¦ Extract and Process Files
      run: |
        echo "ğŸ“¦ Extracting downloaded archive..."
        unzip -q kwrt-packages.zip
        
        echo "ğŸ§¹ Cleaning existing packages directory..."
        rm -rf ${{ env.PACKAGES_DIR }}/*
        
        # ğŸ’¾ Restore .gitkeep if it existed
        if [ -f /tmp/.gitkeep.backup ]; then
          echo "ğŸ’¾ Restoring .gitkeep file..."
          mv /tmp/.gitkeep.backup ${{ env.PACKAGES_DIR }}/.gitkeep
        fi
        
        echo "ğŸ“‹ Processing and moving files..."
        cd kwrt-packages-main
        
        # ğŸ“Š Count files before moving
        TOTAL_FILES=$(find . -maxdepth 1 -type f -not -name 'README.md' | wc -l)
        TOTAL_DIRS=$(find . -maxdepth 1 -type d -not -name '.' -not -name '.github' | wc -l)
        
        echo "ğŸ“Š Files to sync: $TOTAL_FILES files, $TOTAL_DIRS directories"
        
        # ğŸšš Move files (exclude README.md and .github)
        find . -maxdepth 1 -type f -not -name 'README.md' -exec mv {} ../${{ env.PACKAGES_DIR }}/ \;
        find . -maxdepth 1 -type d -not -name '.' -not -name '.github' -exec mv {} ../${{ env.PACKAGES_DIR }}/ \;
        
        cd ..
        
        echo "ğŸ§¹ Cleaning up temporary files..."
        rm -rf kwrt-packages.zip kwrt-packages-main
        
        echo "âœ… File processing completed!"
    
    - name: ğŸ” Analyze Changes
      id: analyze_changes
      run: |
        echo "ğŸ” Analyzing changes in repository..."
        
        # Check for changes
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected in packages directory"
          
          # Count changes
          ADDED=$(git status --porcelain | grep "^A" | wc -l)
          MODIFIED=$(git status --porcelain | grep "^M" | wc -l)
          DELETED=$(git status --porcelain | grep "^D" | wc -l)
          UNTRACKED=$(git status --porcelain | grep "^??" | wc -l)
          
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "untracked=$UNTRACKED" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Change summary:"
          echo "  â• Added: $ADDED files"
          echo "  âœï¸ Modified: $MODIFIED files"
          echo "  âŒ Deleted: $DELETED files"
          echo "  ğŸ“„ Untracked: $UNTRACKED files"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected"
        fi
    
    - name: ğŸ’¾ Commit and Push Changes
      if: steps.analyze_changes.outputs.changes == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        echo "ğŸ’¾ Committing changes to repository..."
        
        git config --global user.email "action@github.com"
        git config --global user.name "ğŸ¤– KWRT Sync Bot"
        
        # Create detailed commit message
        COMMIT_MSG="ğŸ”„ Auto-sync: Update KWRT packages

        ğŸ“… Sync Date: ${{ env.SYNC_DATE }}
        ğŸ“¡ Source: ${{ env.KWRT_REPO_URL }}
        ğŸ”— Commit Hash: ${{ env.COMMIT_HASH }}
        
        ğŸ“Š Changes Summary:
        â• Added: ${{ steps.analyze_changes.outputs.added || 0 }} files
        âœï¸ Modified: ${{ steps.analyze_changes.outputs.modified || 0 }} files
        âŒ Deleted: ${{ steps.analyze_changes.outputs.deleted || 0 }} files
        ğŸ“„ New: ${{ steps.analyze_changes.outputs.untracked || 0 }} files"
        
        git add ${{ env.PACKAGES_DIR }}/
        git commit -m "$COMMIT_MSG"
        git push
        
        echo "âœ… Changes committed and pushed successfully!"
    
    - name: ğŸ“‹ Generate Summary Report
      run: |
        echo "ğŸ“‹ Generating sync summary report..."
        
        echo "# ğŸ”„ KWRT Packages Sync Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š Sync Information" >> $GITHUB_STEP_SUMMARY
        echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“… **Sync Date** | \`${{ env.SYNC_DATE }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“¡ **Source Repository** | [${{ env.KWRT_REPO_URL }}](${{ env.KWRT_REPO_URL }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”— **Workflow Run** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ steps.analyze_changes.outputs.changes }}" == "true" ]]; then
          echo "## âœ… Sync Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Changes Detected and Applied" >> $GITHUB_STEP_SUMMARY
          echo "| Change Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| â• **Added** | \`${{ steps.analyze_changes.outputs.added || 0 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âœï¸ **Modified** | \`${{ steps.analyze_changes.outputs.modified || 0 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ **Deleted** | \`${{ steps.analyze_changes.outputs.deleted || 0 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“„ **New Files** | \`${{ steps.analyze_changes.outputs.untracked || 0 }}\` |" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
          echo "## ğŸ”§ Sync Status: FORCED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”§ **Force sync was triggered manually**" >> $GITHUB_STEP_SUMMARY
        else
          echo "## â„¹ï¸ Sync Status: NO CHANGES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **Repository is already up to date**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ğŸ¤– Automated sync powered by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ‰ Sync Completion
      run: |
        echo "ğŸ‰ KWRT Packages sync workflow completed successfully!"
        echo "ğŸ“Š Summary:"
        echo "  ğŸ“… Date: ${{ env.SYNC_DATE }}"
        echo "  ğŸ“¡ Source: ${{ env.KWRT_REPO_URL }}"
        echo "  ğŸ”„ Status: $([ "${{ steps.analyze_changes.outputs.changes }}" == "true" ] && echo "âœ… Updated" || echo "â„¹ï¸ No changes")"