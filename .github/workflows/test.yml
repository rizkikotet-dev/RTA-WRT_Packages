name: Build OpenWrt Packages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'packages/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'packages/**'
  workflow_dispatch:
    inputs:
      package:
        description: 'Optional: Name of the single package to build (e.g., my-package)'
        required: false
        type: string

env:
  FORCE_UNSAFE_CONFIGURE: 1

jobs:
  build:
    name: Build ${{ matrix.openwrt.version }} ${{ matrix.target.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        openwrt:
          - version: "24.10.1"
            branch: "24.10"
            pkg_ext: "ipk"
            base_url: "https://downloads.openwrt.org/releases/24.10.1/targets"
          - version: "23.05.5"
            branch: "23.05"
            pkg_ext: "ipk"
            base_url: "https://downloads.openwrt.org/releases/23.05.5/targets"
          - version: "SNAPSHOT"
            branch: "SNAPSHOT"
            pkg_ext: "apk"
            base_url: "https://downloads.openwrt.org/snapshots/targets"
        target:
          - arch: x86_64
            target_system: "x86/64"
            target_name: "x86-64"
            sdk_suffix_snapshots: "_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_24_10: "_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_23_05: "_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          - arch: aarch64_generic
            target_system: "armsr/armv8"
            target_name: "armsr-armv8"
            sdk_suffix_snapshots: "_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_24_10: "_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_23_05: "_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          - arch: aarch64_cortex-a53
            target_system: "mediatek/filogic"
            target_name: "mediatek-filogic"
            sdk_suffix_snapshots: "_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_24_10: "_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_23_05: "_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          - arch: aarch64_cortex-a72
            target_system: "bcm27xx/bcm2711"
            target_name: "bcm27xx-bcm2711"
            sdk_suffix_snapshots: "_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_24_10: "_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_23_05: "_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
          - arch: aarch64_cortex-a76
            target_system: "rockchip/armv8"
            target_name: "rockchip-armv8"
            sdk_suffix_snapshots: "_gcc-14.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_24_10: "_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
            sdk_suffix_23_05: "_gcc-12.3.0_musl.Linux-x86_64.tar.xz"

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—‘ï¸ Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
        echo "âœ… Disk space freed"

    - name: ğŸ› ï¸ Setup build environment
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq build-essential ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-setuptools python3-dev rsync subversion swig time unzip wget xsltproc zlib1g-dev zstd libtool libtool-bin autoconf automake pkg-config
        echo "âœ… Build environment ready"

    - name: ğŸŒ Generate SDK URL and filename
      run: |
        if [ "${{ matrix.openwrt.version }}" = "SNAPSHOT" ]; then
          SDK_URL="${{ matrix.openwrt.base_url }}/${{ matrix.target.target_system }}/openwrt-sdk-${{ matrix.target.target_name }}${{ matrix.target.sdk_suffix_snapshots }}"
          SDK_FILENAME="openwrt-sdk.tar.zst"
        elif [ "${{ matrix.openwrt.version }}" = "24.10.1" ]; then
          SDK_URL="${{ matrix.openwrt.base_url }}/${{ matrix.target.target_system }}/openwrt-sdk-${{ matrix.openwrt.version }}-${{ matrix.target.target_name }}${{ matrix.target.sdk_suffix_24_10 }}"
          SDK_FILENAME="openwrt-sdk.tar.zst"
        elif [ "${{ matrix.openwrt.version }}" = "23.05.5" ]; then
          SDK_URL="${{ matrix.openwrt.base_url }}/${{ matrix.target.target_system }}/openwrt-sdk-${{ matrix.openwrt.version }}-${{ matrix.target.target_name }}${{ matrix.target.sdk_suffix_23_05 }}"
          SDK_FILENAME="openwrt-sdk.tar.xz"
        else
          echo "âŒ Unsupported OpenWrt version: ${{ matrix.openwrt.version }}"
          exit 1
        fi
        echo "SDK_URL=$SDK_URL" >> $GITHUB_ENV
        echo "SDK_FILENAME=$SDK_FILENAME" >> $GITHUB_ENV
        echo "âœ… SDK URL generated"

    - name: ğŸ“¥ Download and extract OpenWrt SDK
      run: |
        echo "ğŸ“¥ Downloading SDK..."
        for i in {1..5}; do
          if wget --tries=3 --retry-connrefused -q "$SDK_URL" -O "$SDK_FILENAME"; then
            file_size=$(stat -c%s "$SDK_FILENAME")
            [ "$file_size" -lt 10000000 ] && { echo "âŒ File too small ($file_size bytes)"; exit 1; }
            if [[ "$SDK_FILENAME" == *.tar.zst ]]; then
              tar --zstd -xf "$SDK_FILENAME"
            elif [[ "$SDK_FILENAME" == *.tar.xz ]]; then
              tar -xf "$SDK_FILENAME"
            fi
            SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -1)
            [ -z "$SDK_DIR" ] && { echo "âŒ SDK directory not found"; ls -la; exit 1; }
            echo "SDK_PATH=$(pwd)/$SDK_DIR" >> $GITHUB_ENV
            rm -f "$SDK_FILENAME"
            echo "âœ… SDK downloaded and extracted"
            exit 0
          fi
          echo "ğŸ”„ Retry $i/5 failed"
          sleep 10
        done
        echo "âŒ Download failed after 5 attempts"
        curl -I "$SDK_URL" || true
        exit 1

    - name: ğŸ“‹ Prepare SDK feeds
      run: |
        cd "$SDK_PATH"
        echo "src-link custom $(pwd)/../packages" >> feeds.conf.default
        ./scripts/feeds update -a >/dev/null 2>&1
        ./scripts/feeds install -a >/dev/null 2>&1
        echo "âœ… Feeds prepared"

    - name: ğŸ“¦ Get package list
      id: packages
      run: |
        if [ -n "${{ github.event.inputs.package }}" ]; then
          PACKAGE="${{ github.event.inputs.package }}"
          if [ -d "./packages/$PACKAGE" ] && [ -f "./packages/$PACKAGE/Makefile" ]; then
            echo "ğŸ” Building single package: $PACKAGE"
            PACKAGES="$PACKAGE"
          else
            echo "âŒ Specified package '$PACKAGE' not found in packages/ directory"
            exit 1
          fi
        else
          echo "ğŸ“¦ Building all packages"
          PACKAGES=""
          for pkg in ./packages/*/; do
            [ -f "$pkg/Makefile" ] && PACKAGES="$PACKAGES $(basename "$pkg")"
          done
          PACKAGES=$(echo "$PACKAGES" | sed 's/^ *//')
        fi
        echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
        [ -z "$PACKAGES" ] && { echo "âŒ No packages found"; exit 1; }
        echo "âœ… Package list retrieved"

    - name: âš™ï¸ Configure SDK
      run: |
        cd "$SDK_PATH"
        make defconfig >/dev/null 2>&1
        echo "âœ… SDK configured"

    - name: ğŸ”¨ Build packages
      run: |
        cd "$SDK_PATH"
        FAILED_PACKAGES=""
        BUILT_PACKAGES=""
        for pkg in ${{ steps.packages.outputs.packages }}; do
          echo "ğŸ”¨ Building $pkg..."
          make package/$pkg/clean V=s >/dev/null 2>&1 || true
          if timeout 30m make package/$pkg/compile V=s J=1 >/dev/null 2>&1; then
            echo "âœ… $pkg built"
            BUILT_PACKAGES="$BUILT_PACKAGES $pkg"
          else
            echo "âŒ $pkg failed"
            FAILED_PACKAGES="$FAILED_PACKAGES $pkg"
            echo "ğŸ“œ Error details:"
            [ -f "logs/package/compile/$pkg.txt" ] && tail -50 "logs/package/compile/$pkg.txt" || echo "No log available"
          fi
        done
        BUILT_PACKAGES=$(echo "$BUILT_PACKAGES" | sed 's/^ *//')
        FAILED_PACKAGES=$(echo "$FAILED_PACKAGES" | sed 's/^ *//')
        echo "BUILT_PACKAGES=$BUILT_PACKAGES" >> $GITHUB_ENV
        echo "FAILED_PACKAGES=$FAILED_PACKAGES" >> $GITHUB_ENV
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ matrix.openwrt.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Arch: ${{ matrix.target.arch }}" >> $GITHUB_STEP_SUMMARY
        echo "- Format: .${{ matrix.openwrt.pkg_ext }}" >> $GITHUB_STEP_SUMMARY
        [ -n "$BUILT_PACKAGES" ] && echo "- âœ… Built: $BUILT_PACKAGES" >> $GITHUB_STEP_SUMMARY
        [ -n "$FAILED_PACKAGES" ] && echo "- âŒ Failed: $FAILED_PACKAGES" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“‚ Collect built packages
      run: |
        cd "$SDK_PATH"
        mkdir -p "../artifacts/${{ matrix.openwrt.branch }}/${{ matrix.target.arch }}"
        if [ -n "$BUILT_PACKAGES" ]; then
          find bin/packages -name "*.${{ matrix.openwrt.pkg_ext }}" -type f | while read pkg_file; do
            package_name=$(basename "$pkg_file" | sed 's/_.*$//')
            echo " $BUILT_PACKAGES " | grep -q " $package_name " && cp "$pkg_file" "../artifacts/${{ matrix.openwrt.branch }}/${{ matrix.target.arch }}/"
          done
          find bin/targets -name "*.${{ matrix.openwrt.pkg_ext }}" -type f 2>/dev/null | xargs -I {} cp {} "../artifacts/${{ matrix.openwrt.branch }}/${{ matrix.target.arch }}/" || true
        fi
        ls "../artifacts/${{ matrix.openwrt.branch }}/${{ matrix.target.arch }}/"*.${{ matrix.openwrt.pkg_ext }} >/dev/null 2>&1 && echo "âœ… Packages collected" || echo "âš ï¸ No packages collected"

    - name: â¬†ï¸ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: packages-${{ matrix.openwrt.branch }}-${{ matrix.target.arch }}
        path: artifacts/${{ matrix.openwrt.branch }}/${{ matrix.target.arch }}/*.${{ matrix.openwrt.pkg_ext }}

  release:
    name: ğŸš€ Release & Deploy Packages
    needs: build
    runs-on: ubuntu-latest
    if: always() && needs.prepare.outputs.should_build == 'true'

    steps:
      - name: ğŸ¯ Release initialization
        run: |
          echo "::notice title=Release Started::ğŸš€ Starting package release process"
          echo "### ğŸš€ Release Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- **Total jobs**: ${{ needs.prepare.outputs.total_jobs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¥ Checkout releases branch
        uses: actions/checkout@v4
        with:
          ref: releases
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: true

      - name: ğŸ”§ Setup release environment
        run: |
          # Install dependencies
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends git-lfs jq zstd pv

          # Configure Git
          git lfs install --local
          git config user.email "actions@github.com"
          git config user.name "ğŸ¤– OpenWRT Package Bot"
          git config pull.rebase true
          git config core.compression 9
          git config pack.compression 9
          git config lfs.concurrenttransfers 8

      - name: ğŸ“‹ Setup LFS tracking
        run: |
          cat > .gitattributes <<'EOF'
          # Package files
          *.ipk filter=lfs diff=lfs merge=lfs -text
          *.apk filter=lfs diff=lfs merge=lfs -text
          *.tar.* filter=lfs diff=lfs merge=lfs -text
          *.gz filter=lfs diff=lfs merge=lfs -text
          
          # Generated content
          packages/** linguist-generated=true
          releases/** linguist-generated=true
          
          # Documentation
          *.md text eol=lf
          *.json text eol=lf
          EOF
          
          git add .gitattributes

      - name: ğŸ“¦ Download and process artifacts
        id: download
        run: |
          echo "::group::ğŸ“¥ Downloading artifacts"
          
          # Create temporary directory
          mkdir -p ./temp-artifacts
          
          # Download all artifacts
          success_count=0
          total_packages=0
          
          # Get all artifacts from the current run
          artifacts=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq '.artifacts[].name' | grep '^packages-' || true)
          
          if [[ -z "$artifacts" ]]; then
            echo "::warning::No package artifacts found"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found artifacts:"
          echo "$artifacts"
          
          # Download with progress tracking
          echo "$artifacts" | while read -r artifact_name; do
            if [[ -n "$artifact_name" ]]; then
              echo "â¬‡ï¸ Downloading: $artifact_name"
              if gh run download ${{ github.run_id }} --name "$artifact_name" --dir "./temp-artifacts/$artifact_name"; then
                ((success_count++))
                echo "âœ… Downloaded: $artifact_name"
              else
                echo "âŒ Failed to download: $artifact_name"
              fi
            fi
          done
          
          echo "::endgroup::"
          
          total_packages=$(find ./temp-artifacts -name "*.ipk" -o -name "*.apk" | wc -l)
          echo "ğŸ“Š Downloaded $success_count artifacts with $total_packages total packages"
          
          echo "success=true" >> $GITHUB_OUTPUT
          echo "total_packages=$total_packages" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Process and organize packages
        if: steps.download.outputs.success == 'true'
        run: |
          echo "::group::ğŸ”„ Processing artifacts"
          
          mkdir -p packages
          total_processed=0
          
          for artifact_dir in ./temp-artifacts/packages-*; do
            [[ -d "$artifact_dir" ]] || continue
            
            artifact_name=$(basename "$artifact_dir")
            echo "ğŸ“ Processing: $artifact_name"
            
            # Parse artifact metadata
            metadata=${artifact_name#packages-}
            arch=${metadata%-*}
            branch=${metadata##*-}
            
            echo "  ğŸ—ï¸ Architecture: $arch"
            echo "  ğŸŒ¿ Branch: $branch"
            
            # Create target structure
            target_dir="packages/$branch/$arch"
            mkdir -p "$target_dir"
            
            # Find and process packages
            for search_path in \
              "$artifact_dir/releases/$branch/$arch" \
              "$artifact_dir"; do
              
              if [[ -d "$search_path" ]]; then
                echo "  ğŸ“¦ Processing packages from: $search_path"
                
                # Copy packages efficiently
                find "$search_path" -name "*.ipk" -o -name "*.apk" | while read -r package; do
                  if [[ -f "$package" ]]; then
                    cp "$package" "$target_dir/"
                    ((total_processed++))
                  fi
                done
                
                # Copy metadata
                [[ -f "$search_path/README.md" ]] && cp "$search_path/README.md" "$target_dir/"
                [[ -f "$search_path/Packages" ]] && cp "$search_path/Packages" "$target_dir/"
                
                break
              fi
            done
            
            # Verify processing
            processed_count=$(find "$target_dir" -name "*.ipk" -o -name "*.apk" | wc -l)
            echo "  âœ… Processed $processed_count packages for $arch/$branch"
          done
          
          echo "::endgroup::"
          echo "ğŸ“Š Total packages processed: $total_processed"

      - name: ğŸ§¹ Intelligent repository cleanup
        run: |
          echo "::group::ğŸ§¹ Repository maintenance"
          
          current_size_gb=$(du -sb . | awk '{print int($1/1024/1024/1024)}')
          echo "ğŸ“ Current repository size: ${current_size_gb}GB"
          
          if [[ $current_size_gb -gt $MAX_REPO_SIZE_GB ]] || [[ "${{ github.event.inputs.force_cleanup }}" == "true" ]]; then
            echo "ğŸ§¹ Cleanup required (size: ${current_size_gb}GB, limit: ${MAX_REPO_SIZE_GB}GB)"
            
            # Strategy 1: Remove duplicate packages (keep latest)
            echo "  ğŸ”„ Deduplicating packages..."
            find packages -name "*.ipk" -o -name "*.apk" | \
              sed 's/_[^_]*\.(ipk|apk)$//' | sort | uniq -d | \
              while read -r base_name; do
                find packages -name "${base_name}_*" | sort -V | head -n -1 | xargs rm -f
              done
            
            # Strategy 2: Remove oldest snapshots first
            echo "  ğŸ—‘ï¸ Removing old snapshots..."
            find packages/SNAPSHOT -name "*.ipk" -o -name "*.apk" | \
              head -n -$((MAX_REPO_SIZE_GB * 200)) | xargs rm -f 2>/dev/null || true
            
            # Strategy 3: Clean empty directories
            find packages -type d -empty -delete 2>/dev/null || true
            
            new_size_gb=$(du -sb . | awk '{print int($1/1024/1024/1024)}')
            echo "  ğŸ“‰ Size after cleanup: ${new_size_gb}GB"
          fi
          
          echo "::endgroup::"

      - name: ğŸ“Š Generate advanced repository metadata
        id: generate_metadata
        run: |
          echo "::group::ğŸ“Š Generating metadata"
          
          # Calculate comprehensive statistics
          total_packages=$(find packages -name "*.ipk" -o -name "*.apk" 2>/dev/null | wc -l)
          total_branches=$(find packages -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l)
          total_archs=$(find packages -mindepth 2 -maxdepth 2 -type d 2>/dev/null | wc -l)
          repo_size_mb=$(du -sm packages 2>/dev/null | cut -f1)
          
          # Store metadata for later use
          echo "total_packages=$total_packages" >> $GITHUB_OUTPUT
          echo "total_branches=$total_branches" >> $GITHUB_OUTPUT
          echo "total_archs=$total_archs" >> $GITHUB_OUTPUT
          echo "repo_size_mb=$repo_size_mb" >> $GITHUB_OUTPUT
          
          # Create comprehensive repository metadata
          cat > packages/repository.json <<EOF
          {
            "repository": {
              "name": "ğŸš€ OpenWRT Custom Packages",
              "description": "Pre-built OpenWRT packages for multiple architectures and versions",
              "version": "2.0.0",
              "updated": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
              "statistics": {
                "total_packages": $total_packages,
                "total_branches": $total_branches,
                "total_architectures": $total_archs,
                "repository_size_mb": $repo_size_mb,
                "last_build_packages": ${{ steps.download.outputs.total_packages || 0 }}
              },
              "branches": $(find packages -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | jq -R . | jq -s .),
              "architectures": $(find packages -mindepth 2 -maxdepth 2 -type d -exec dirname {} \; | xargs -n1 basename | sort -u | jq -R . | jq -s .),
              "build_info": {
                "workflow_run_id": "${{ github.run_id }}",
                "commit_sha": "${{ github.sha }}",
                "trigger": "${{ github.event_name }}",
                "source_repository": "$SOURCE_REPO"
              },
              "usage": {
                "opkg_source": "src/gz custom_packages https://raw.githubusercontent.com/${{ github.repository }}/releases/packages/[BRANCH]/[ARCH]",
                "browse_url": "https://github.com/${{ github.repository }}/tree/releases/packages"
              }
            }
          }
          EOF
          
          # Generate beautiful README with modern formatting
          {
            cat <<'HEADER'
          # ğŸš€ OpenWRT Custom Packages Repository
          
          <div align="center">
            <img src="https://img.shields.io/badge/OpenWRT-Packages-blue?style=for-the-badge&logo=openwrt" alt="OpenWRT Packages">
            <img src="https://img.shields.io/badge/Status-Active-success?style=for-the-badge" alt="Status">
            <img src="https://img.shields.io/badge/Auto--Updated-Weekly-informational?style=for-the-badge" alt="Auto Updated">
          </div>
          
          <div align="center">
            <h3>ğŸ¯ Pre-built packages for multiple OpenWRT versions and architectures</h3>
            <p><em>Automated builds â€¢ Quality assured â€¢ Always up-to-date</em></p>
          </div>
          
          ---
          
          ## ğŸ“Š Repository Statistics
          
          <table>
            <tr>
              <td align="center"><strong>ğŸ“¦ Total Packages</strong></td>
              <td align="center"><strong>ğŸ—ï¸ Architectures</strong></td>
              <td align="center"><strong>ğŸŒ¿ Branches</strong></td>
              <td align="center"><strong>ğŸ’¾ Repository Size</strong></td>
            </tr>
            <tr>
              <td align="center">
          HEADER
            echo "    <img src=\"https://img.shields.io/badge/$total_packages-packages-blue?style=flat-square\" alt=\"$total_packages packages\">"
            echo "  </td>"
            echo "  <td align=\"center\">"
            echo "    <img src=\"https://img.shields.io/badge/$total_archs-architectures-green?style=flat-square\" alt=\"$total_archs architectures\">"
            echo "  </td>"
            echo "  <td align=\"center\">"
            echo "    <img src=\"https://img.shields.io/badge/$total_branches-branches-orange?style=flat-square\" alt=\"$total_branches branches\">"
            echo "  </td>"
            echo "  <td align=\"center\">"
            echo "    <img src=\"https://img.shields.io/badge/${repo_size_mb}MB-size-red?style=flat-square\" alt=\"${repo_size_mb}MB\">"
            echo "  </td>"
            echo "</tr>"
            echo "</table>"
            echo ""
            echo "> ğŸ• **Last updated**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            
            # Generate branch information
            echo "## ğŸŒ¿ Supported OpenWRT Versions"
            echo ""
            
            for branch_dir in packages/*; do
              if [[ -d "$branch_dir" ]]; then
                branch_name=$(basename "$branch_dir")
                branch_packages=$(find "$branch_dir" -name "*.ipk" -o -name "*.apk" | wc -l)
                branch_archs=$(find "$branch_dir" -mindepth 1 -maxdepth 1 -type d | wc -l)
                
                # Branch status badge
                if [[ "$branch_name" == "SNAPSHOT" ]]; then
                  badge="![SNAPSHOT](https://img.shields.io/badge/SNAPSHOT-Development-red?style=flat-square)"
                else
                  badge="![Stable](https://img.shields.io/badge/$branch_name-Stable-green?style=flat-square)"
                fi
                
                echo "### $badge"
                echo ""
                echo "| Architecture | Packages | Status |"
                echo "|--------------|----------|--------|"
                
                for arch_dir in "$branch_dir"/*; do
                  if [[ -d "$arch_dir" ]]; then
                    arch_name=$(basename "$arch_dir")
                    arch_packages=$(find "$arch_dir" -name "*.ipk" -o -name "*.apk" | wc -l)
                    if [[ $arch_packages -gt 0 ]]; then
                      echo "| \`$arch_name\` | $arch_packages | âœ… Available |"
                    fi
                  fi
                done
                echo ""
              fi
            done
            
            # Usage section
            cat <<'USAGE'
          ## ğŸš€ Quick Start
          
          ### Method 1: Add Repository Source
          
          ```bash
          # Add custom repository (replace [BRANCH] and [ARCH] with your values)
          echo "src/gz custom_packages https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT_Packages/releases/packages/[BRANCH]/[ARCH]" >> /etc/opkg/customfeeds.conf
          
          # Update package lists
          opkg update
          
          # Install packages
          opkg install [package_name]
          ```
          
          ### Method 2: Direct Download
          
          Browse packages directly at: [ğŸ“‚ Package Browser](../../tree/releases/packages)
          
          ### Method 3: Batch Installation Script
          
          ```bash
          #!/bin/bash
          # Auto-detect architecture and install packages
          ARCH=$(opkg print-architecture | awk 'NR==2{print $2}')
          BRANCH="23.05"  # or 24.10, SNAPSHOT
          
          # Add repository
          echo "src/gz custom_packages https://raw.githubusercontent.com/rizkikotet-dev/RTA-WRT_Packages/releases/packages/$BRANCH/$ARCH" > /etc/opkg/customfeeds.conf
          
          # Update and install
          opkg update
          opkg list | grep custom_packages
          ```

          ## ğŸ›¡ï¸ Quality Assurance
          
          - âœ… **Automated Testing**: All packages undergo validation
          - ğŸ”„ **Weekly Builds**: Fresh packages every week
          - ğŸ“Š **Build Monitoring**: Failed builds are tracked and fixed
          - ğŸ·ï¸ **Version Tracking**: Clear versioning and changelog
          
          ## ğŸ¤ Contributing
          
          Want to add your packages? Here's how:
          
          1. **Fork** this repository
          2. **Add** your packages to the `packages/` directory
          3. **Test** locally with OpenWRT SDK
          4. **Submit** a pull request
          
          ### Package Structure
          ```
          packages/
          â”œâ”€â”€ your-package/
          â”‚   â”œâ”€â”€ Makefile
          â”‚   â”œâ”€â”€ files/
          â”‚   â””â”€â”€ patches/
          ```
          
          ## ğŸ› Troubleshooting
          
          <details>
          <summary>â“ <strong>Common Issues & Solutions</strong></summary>
          
          ### Package Installation Fails
          ```bash
          # Clear opkg cache and retry
          rm -rf /tmp/opkg-lists/*
          opkg update
          opkg install [package_name]
          ```
          
          ### Architecture Mismatch
          ```bash
          # Check your device architecture
          opkg print-architecture
          # Use the correct architecture in repository URL
          ```
          
          ### Repository Not Found
          ```bash
          # Verify repository URL is correct
          cat /etc/opkg/customfeeds.conf
          ```
          
          </details>
          
          ## ğŸ“ˆ Build Status & Monitoring
          
          <div align="center">
            <a href="../../actions">
              <img src="https://img.shields.io/github/actions/workflow/status/rizkikotet-dev/RTA-WRT_Packages/build.yml?branch=main&style=for-the-badge&logo=github-actions" alt="Build Status">
            </a>
            <a href="../../releases">
              <img src="https://img.shields.io/github/v/release/rizkikotet-dev/RTA-WRT_Packages?style=for-the-badge&logo=github" alt="Latest Release">
            </a>
            <a href="../../commits/main">
              <img src="https://img.shields.io/github/last-commit/rizkikotet-dev/RTA-WRT_Packages?style=for-the-badge&logo=git" alt="Last Commit">
            </a>
          </div>
          
          ## ğŸ“ Support & Community
          
          - ğŸ› **Bug Reports**: [Create an Issue](../../issues/new?template=bug_report.md)
          - ğŸ’¡ **Feature Requests**: [Request Feature](../../issues/new?template=feature_request.md)
          - ğŸ’¬ **Discussions**: [Join Discussion](../../discussions)
          - ğŸ“§ **Contact**: [Email Support](mailto:support@example.com)
          
          ## ğŸ“„ License & Legal
          
          This repository contains packages from various sources. Each package maintains its original license.
          
          - ğŸ“œ **Repository License**: MIT
          - âš–ï¸ **Package Licenses**: Varies (see individual packages)
          - ğŸ”’ **Privacy Policy**: No personal data collected
          
          ---
          
          <div align="center">
            <h3>ğŸŒŸ Star this repository if it helps you!</h3>
            <p>
              <a href="../../stargazers">â­ Star</a> â€¢
              <a href="../../network/members">ğŸ´ Fork</a> â€¢
              <a href="../../issues">ğŸ› Report Bug</a> â€¢
              <a href="../../discussions">ğŸ’¬ Discuss</a>
            </p>
          </div>
          
          <div align="center">
            <sub>Built with â¤ï¸ using GitHub Actions â€¢ Powered by OpenWRT | RizkiKotet</sub>
          </div>
          USAGE
          } > README.md
          
          echo "::endgroup::"
          echo "âœ… Generated enhanced repository metadata"

      - name: ğŸš€ Smart commit and deployment
        run: |
          echo "::group::ğŸš€ Deploying changes"
          
          # Check for changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # Stage metadata files
          git add .gitattributes packages/repository.json README.md
          
          # Commit metadata first
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ“ Update repository metadata" \
                      -m "ğŸ• Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
                      -m "ğŸ“¦ Packages: $(find packages -name '*.ipk' -o -name '*.apk' | wc -l)" \
                      -m "ğŸ—ï¸ Build: ${{ github.run_id }}" \
                      -m "ğŸŒ¿ Source: $SOURCE_REPO"
          fi
          
          # Process packages by architecture with progress
          total_packages=$(find packages -name "*.ipk" -o -name "*.apk" | wc -l)
          
          if [[ $total_packages -gt 0 ]]; then
            echo "ğŸ“¤ Committing $total_packages packages..."
            
            # Track LFS files
            git lfs track "*.ipk" "*.apk"
            git add .gitattributes
            
            # Smart batching by architecture
            processed=0
            for branch_dir in packages/*; do
              if [[ -d "$branch_dir" ]]; then
                branch=$(basename "$branch_dir")
                
                for arch_dir in "$branch_dir"/*; do
                  if [[ -d "$arch_dir" ]]; then
                    arch=$(basename "$arch_dir")
                    arch_packages=$(find "$arch_dir" -name "*.ipk" -o -name "*.apk" | wc -l)
                    
                    if [[ $arch_packages -gt 0 ]]; then
                      echo "  ğŸ“¦ Committing $arch_packages packages for $branch/$arch"
                      
                      # Progress indicator
                      progress=$((processed * 100 / total_packages))
                      echo "::notice::Progress: $progress% ($processed/$total_packages packages)"
                      
                      git add "$arch_dir"
                      
                      if ! git diff --cached --quiet; then
                        git commit -m "ğŸ“¦ Add $branch/$arch packages" \
                                  -m "ğŸ—ï¸ Architecture: $arch" \
                                  -m "ğŸŒ¿ Branch: $branch" \
                                  -m "ğŸ“Š Count: $arch_packages packages" \
                                  -m "ğŸ”§ Build: ${{ github.run_id }}"
                      fi
                      
                      processed=$((processed + arch_packages))
                    fi
                  fi
                done
              fi
            done
          fi
          
          echo "::endgroup::"
          
          echo "::group::ğŸŒ Pushing to GitHub"
          
          # Enhanced push with retry and conflict resolution
          max_retries=5
          retry_delay=30
          
          for attempt in $(seq 1 $max_retries); do
            echo "ğŸš€ Push attempt $attempt/$max_retries"
            
            if git push origin releases; then
              echo "âœ… Successfully pushed on attempt $attempt"
              echo "ğŸ‰ Deployment completed successfully!"
              break
            else
              echo "âš ï¸ Push attempt $attempt failed"
              
              if [[ $attempt -eq $max_retries ]]; then
                echo "âŒ All push attempts failed"
                exit 1
              fi
              
              echo "â³ Waiting ${retry_delay}s before retry..."
              sleep $retry_delay
              
              # Attempt conflict resolution
              echo "ğŸ”„ Attempting to resolve conflicts..."
              git pull --rebase origin releases || {
                echo "âŒ Failed to resolve conflicts"
                git rebase --abort
                git pull --strategy-option=theirs origin releases
              }
              
              # Exponential backoff
              retry_delay=$((retry_delay * 2))
            fi
          done
          
          echo "::endgroup::"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ Generate success summary
        if: success()
        run: |
          total_packages=$(find packages -name "*.ipk" -o -name "*.apk" | wc -l)
          repo_size=$(du -sh packages | cut -f1)
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ğŸ‰ Release Completed Successfully!
          
          ### ğŸ“Š Final Statistics
          - **Total Packages**: $total_packages
          - **Repository Size**: $repo_size
          - **Build Duration**: ${{ job.duration || 'N/A' }}
          - **Commit SHA**: \`${{ github.sha }}\`
          
          ### ğŸ”— Quick Links
          - ğŸ“¦ [Browse Packages](../../tree/releases/packages)
          - ğŸ“‹ [Repository Metadata](../../blob/releases/packages/repository.json)
          - ğŸƒ [View Workflow](../../actions/runs/${{ github.run_id }})
          
          ### ğŸš€ What's Next?
          1. Packages are now available in the \`releases\` branch
          2. Users can add the repository to their OpenWRT devices
          3. Automated weekly builds will keep packages updated
          
          ---
          *Generated on $(date -u '+%Y-%m-%d %H:%M:%S UTC') by GitHub Actions*
          EOF

  cleanup:
    name: ğŸ§¹ Cleanup & Maintenance
    runs-on: ubuntu-latest
    needs: [build, release]
    if: always()
    
    steps:
      - name: ğŸ“Š Workflow summary
        run: |
          echo "### ğŸ Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Success' || needs.build.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result == 'success' && 'âœ… Success' || needs.release.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” Notification on failure
        if: failure()
        run: |
          echo "::error title=Workflow Failed::âŒ The OpenWRT package build workflow has failed"
          echo "Please check the logs and fix any issues before the next scheduled run."